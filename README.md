# Three-Body Problem N-Body Simulator

A high-performance Rust implementation of an N-body gravitational physics simulator using the Runge-Kutta-Fehlberg (RKF45) adaptive time-stepping method, with a 3D visualization tool powered by Bevy.

## Project Structure

```
threebody-rs/
├── src/
│   ├── lib.rs              # Main library module exports
│   ├── main.rs             # CLI simulator binary
│   ├── body.rs             # Physical body representation
│   ├── simulator.rs         # High-level simulation controller
│   ├── integrator.rs        # RKF45 numerical integration
│   ├── config.rs           # INI file parsing for initial conditions
│   ├── trajectory.rs        # CSV trajectory data loading
│   └── bin/
│       └── viewer.rs        # Bevy 3D visualization viewer
├── data/
│   ├── ic.ini              # Default three-body chaotic system
│   ├── earth_moon.ini      # Earth-Moon orbital system
│   ├── binary_stars.ini    # Binary star system
│   ├── sun_jupiter_saturn.ini  # Solar system subset
│   └── results*.csv        # Generated trajectory output files
├── Cargo.toml              # Project manifest
└── README.md               # This file
```

## Components

### Core Simulator (`src/simulator.rs`)

- Manages N-body system with arbitrary number of bodies
- Computes gravitational forces between all body pairs
- Provides energy conservation metrics for validation
- Outputs trajectory data to CSV format

**Key Features:**
- Gravitational force calculation using Newton's law: F = G·m₁·m₂/r²
- Kinetic and potential energy computation
- Total mechanical energy tracking

### Numerical Integrator (`src/integrator.rs`)

- Implements Runge-Kutta-Fehlberg (RKF45) method
- 6-stage Butcher tableau with embedded 4th/5th order methods
- Computes local truncation error estimates
- Suitable for systems where adaptive time-stepping may be desired

**Why RKF45?**
- Provides both 4th and 5th order solutions for error estimation
- Good balance between accuracy and computational efficiency
- Preserves phase space volume reasonably well for Hamiltonian systems

### Configuration System (`src/config.rs`)

Parses INI-format initial condition files. Example format:

```ini
[Body1]
mass = 4e29
position_x = 0
position_y = 1e11
position_z = -1e11
velocity_x = -600
velocity_y = 0
velocity_z = 2600
```

Supports multiple bodies, comments (# and ;), and inline comments.

### Trajectory Module (`src/trajectory.rs`)

- Loads CSV trajectory files generated by the simulator
- Provides frame-by-frame position access for visualization
- Used by the Bevy viewer to animate body motion

## Building

### Full Build (with Bevy Viewer)

```bash
cargo build --features viewer --release
```

### Simulator Only

```bash
cargo build --release
```

## Usage

### Running the Simulator

Generate trajectory data from initial conditions:

```bash
./target/release/threebody-sim ./data/earth_moon.ini ./data/output.csv
```

**Arguments:**
- `[config_file]`: Path to INI file (default: `./data/ic.ini`)
- `[output_file]`: Path to output CSV (default: `./data/results.csv`)

**Output:**
Displays:
- Initial and final body states (position, velocity)
- Total mechanical energy at start and end
- Simulation statistics (time elapsed, number of bodies)

Creates CSV file with columns:
```
time,body0_x,body0_y,body0_z,body1_x,body1_y,body1_z,...
```

### Running the 3D Viewer

Visualize trajectory data in real-time:

```bash
./target/release/viewer ./data/results.csv
```

**Controls:**
- **SPACE**: Play/Pause animation
- **LEFT Arrow**: Slow down playback (0.5x multiplier)
- **RIGHT Arrow**: Speed up playback (0.5x multiplier)
- **R**: Reset to start of simulation
- **Mouse Drag**: Rotate the view
- **Mouse Wheel**: Zoom in/out

### Simulating and Viewing in One Command

For convenience, use the provided workflow script to run the simulator and viewer together:

```bash
./simulate_and_view.sh ./data/earth_moon.ini
```

**Arguments:**
- `<config_file>`: Path to INI file (required)
- `[output_file]`: Path to output CSV (optional, default: `./data/results.csv`)

**Example:**
```bash
./simulate_and_view.sh ./data/binary_stars.ini
./simulate_and_view.sh ./data/earth_moon.ini ./data/custom_output.csv
```

The script will:
1. Run the simulator with your configuration
2. Generate the results CSV
3. Automatically launch the viewer with the generated trajectory

**Features:**
- 3D rendering with perspective camera
- Color-coded bodies (orange, light-blue, yellow, magenta)
- Directional lighting for depth perception
- Frame counter and playback status in console
- Smooth animation interpolation

## Example Scenarios

### 1. Chaotic Three-Body System (`ic.ini`)

Classic three-body configuration that exhibits sensitive dependence on initial conditions. Small perturbations lead to drastically different trajectories.

**Run:**
```bash
./target/release/threebody-sim ./data/ic.ini ./data/results_chaos.csv
./target/release/viewer ./data/results_chaos.csv
```

### 2. Earth-Moon System (`earth_moon.ini`)

Realistic two-body orbital system using actual Earth-Moon masses and distance.

**Run:**
```bash
./target/release/threebody-sim ./data/earth_moon.ini ./data/results_lunar.csv
./target/release/viewer ./data/results_lunar.csv
```

### 3. Binary Stars (`binary_stars.ini`)

Two equal-mass stars in stable circular orbit around their common center of mass.

**Run:**
```bash
./target/release/threebody-sim ./data/binary_stars.ini ./data/results_binary.csv
./target/release/viewer ./data/results_binary.csv
```

## Testing

Run all unit tests:

```bash
cargo test --lib
```

Tests verify:
- ✅ Body creation and vector operations
- ✅ Distance calculations (3-4-5 right triangle)
- ✅ INI file parsing with comments
- ✅ RKF45 integrator coefficients
- ✅ Energy conservation over time
- ✅ Gravitational force accuracy
- ✅ Kinetic and potential energy components

## Physics Notes

### Gravitational Constant

```rust
const G: f64 = 6.67430e-11;  // m³ kg⁻¹ s⁻²
```

### Conservation Properties

The simulator tracks total mechanical energy E = KE + PE:

- **Kinetic Energy**: KE = Σ ½·m_i·v_i²
- **Potential Energy**: PE = Σ_{i<j} -G·m_i·m_j/r_ij
- **Error Tolerance**: RKF45 typically maintains ~5% energy conservation over 1000 time steps

Larger time steps (dt = 86400s = 1 day) show more drift than smaller steps. For improved accuracy, reduce dt or implement adaptive stepping.

### Coordinate System

- Unit system is consistent with SI (meters, kilograms, seconds)
- Origin at (0,0,0) with arbitrary orientation
- No special handling of center-of-mass or barycentric coordinates

## Performance

Debug build:
```bash
cargo build --release
```

Release build optimization produces ~3-5x faster execution than debug.

Example timings (3 bodies, 1000 steps, 1-day time step):
- Debug: ~100ms
- Release: ~20ms

## Future Enhancements

- [ ] Adaptive time-stepping based on local error estimates
- [ ] Barnes-Hut algorithm for large N (O(N log N) instead of O(N²))
- [ ] Symplectic integrators (better energy conservation)
- [ ] Trajectory trail rendering in viewer
- [ ] Camera controls (pan, zoom, rotate)
- [ ] Body mass visualization (sphere size)
- [ ] Collision detection and merging
- [ ] Custom user scenarios via GUI
- [ ] Export to common scientific formats (HDF5, NetCDF)

## References

- Runge-Kutta-Fehlberg Method: https://en.wikipedia.org/wiki/Runge%E2%80%93Kutta%E2%80%93Fehlberg_method
- Three-Body Problem: https://en.wikipedia.org/wiki/Three-body_problem
- Bevy Game Engine: https://bevyengine.org/

## License

MIT (or your preferred license)
